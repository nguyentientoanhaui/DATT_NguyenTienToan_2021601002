@model ProductModel
@{
    ViewData["title"] = "Thêm đồng hồ mới";
}
<h4>Thêm đồng hồ cao cấp mới</h4>
<div class="col-md-12">
    <form asp-action="Create" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        
        <!-- Basic Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Thông tin cơ bản</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Tên đồng hồ</label>
                            <input asp-for="Name" class="form-control" placeholder="Ví dụ: Rolex Submariner Date" />
                            <span asp-validation-for="Name" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Model</label>
                            <input asp-for="Model" class="form-control" placeholder="Ví dụ: Submariner" />
                            <span asp-validation-for="Model" class="text-danger" />
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Model Number</label>
                            <input asp-for="ModelNumber" class="form-control" placeholder="Ví dụ: 126610LN" />
                            <span asp-validation-for="ModelNumber" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Năm sản xuất</label>
                            <input asp-for="Year" type="number" class="form-control" placeholder="Ví dụ: 2023" />
                            <span asp-validation-for="Year" class="text-danger" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Thông tin giá</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Giá bán (VNĐ)</label>
                            <input asp-for="Price" pattern="[0-9.,]+" class="form-control typing-price" />
                            <span id="price-convert"></span>
                            <span asp-validation-for="Price" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Giá vốn (VNĐ)</label>
                            <input asp-for="CapitalPrice" pattern="[0-9.,]+" class="form-control typing-price" />
                            <span asp-validation-for="CapitalPrice" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Giá thẻ tín dụng (VNĐ)</label>
                            <input asp-for="CreditCardPrice" pattern="[0-9.,]+" class="form-control typing-price" />
                            <span asp-validation-for="CreditCardPrice" class="text-danger" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watch Specifications -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Thông số kỹ thuật</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Giới tính</label>
                            <select asp-for="Gender" class="form-control" asp-items="ViewBag.GenderOptions">
                                <option value="">-- Chọn giới tính --</option>
                            </select>
                            <span asp-validation-for="Gender" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Tình trạng</label>
                            <select asp-for="Condition" class="form-control" asp-items="ViewBag.ConditionOptions">
                                <option value="">-- Chọn tình trạng --</option>
                            </select>
                            <span asp-validation-for="Condition" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Case Size</label>
                            <input asp-for="CaseSize" class="form-control" placeholder="Ví dụ: 41mm" />
                            <span asp-validation-for="CaseSize" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Case Material</label>
                            <select asp-for="CaseMaterial" class="form-control" asp-items="ViewBag.CaseMaterialOptions">
                                <option value="">-- Chọn chất liệu --</option>
                            </select>
                            <span asp-validation-for="CaseMaterial" class="text-danger" />
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Movement Type</label>
                            <select asp-for="MovementType" class="form-control" asp-items="ViewBag.MovementTypeOptions">
                                <option value="">-- Chọn loại máy --</option>
                            </select>
                            <span asp-validation-for="MovementType" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Calibre</label>
                            <input asp-for="Calibre" class="form-control" placeholder="Ví dụ: 3235" />
                            <span asp-validation-for="Calibre" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Bracelet Material</label>
                            <select asp-for="BraceletMaterial" class="form-control" asp-items="ViewBag.BraceletMaterialOptions">
                                <option value="">-- Chọn chất liệu dây --</option>
                            </select>
                            <span asp-validation-for="BraceletMaterial" class="text-danger" />
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Dial Color</label>
                            <input asp-for="DialColor" class="form-control" placeholder="Ví dụ: Black, Blue, Green" />
                            <span asp-validation-for="DialColor" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Serial Number</label>
                            <input asp-for="SerialNumber" class="form-control" placeholder="Serial number của đồng hồ" />
                            <span asp-validation-for="SerialNumber" class="text-danger" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories and Brand -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Phân loại</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Thương hiệu</label>
                            <select asp-for="BrandId" id="MainBrandId" class="form-control" asp-items="ViewBag.Brands">
                                <option>--Chọn thương hiệu--</option>
                            </select>
                            <span asp-validation-for="BrandId" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Phân loại sản phẩm</label>
                            <select asp-for="CategoryId" id="SubCategoryId" class="form-control" asp-items="ViewBag.Categories">
                                <option>--Chọn phân loại--</option>
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Số lượng tồn kho</label>
                            <input asp-for="Quantity" type="number" class="form-control" value="1" />
                            <span asp-validation-for="Quantity" class="text-danger" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Thông tin bổ sung</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Box & Papers</label>
                            <select asp-for="BoxAndPapers" class="form-control">
                                <option value="">-- Chọn --</option>
                                <option value="true">Có</option>
                                <option value="false">Không</option>
                            </select>
                            <span asp-validation-for="BoxAndPapers" class="text-danger" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Chứng nhận</label>
                            <input asp-for="Certificate" class="form-control" placeholder="Ví dụ: COSC, Chronometer" />
                            <span asp-validation-for="Certificate" class="text-danger" />
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Mô tả chi tiết</label>
                    <textarea asp-for="Description" class="form-control" rows="4" placeholder="Mô tả chi tiết về đồng hồ..."></textarea>
                    <span asp-validation-for="Description" class="text-danger" />
                </div>
            </div>
        </div>

        <!-- Image Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Quản lý hình ảnh đồng hồ</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Tải lên ảnh đồng hồ</h6>
                    <input type="file" name="AdditionalImages" multiple class="form-control" id="image-upload" required />
                    <small class="form-text text-muted">Có thể chọn nhiều ảnh cùng lúc. Ảnh đầu tiên sẽ là ảnh chính.</small>
                </div>

                <div class="mt-3" id="new-images-preview">
                    <h6>Xem trước ảnh đồng hồ</h6>
                    <div class="d-flex flex-wrap" id="image-previews-container"></div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <button class="btn btn-primary">Thêm đồng hồ mới</button>
            <a asp-action="Index" class="btn btn-secondary">Trở lại danh sách</a>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('Description');
    </script>
    <script>
        $(".typing-price").on("keyup", function(){
            var currency_input = $(this).val();

            $("#price-convert").html(
                new Intl.NumberFormat('vn-VN', {style: 'currency', currency: 'VND'})
                .format(currency_input));
        });
    </script>
    <script>
        $(document).ready(function() {
            // Hàm load phân loại sản phẩm theo thương hiệu
            function loadProductCategories(brandId) {
                $.ajax({
                    type: "GET",
                    url: "/Admin/Product/GetCategoriesByBrand",
                    data: { brandId: brandId },
                    success: function(data) {
                        var subCategorySelect = $('#SubCategoryId');
                        subCategorySelect.empty();
                        subCategorySelect.append('<option>--Chọn phân loại--</option>');
                        $.each(data, function(i, item) {
                            subCategorySelect.append(`<option value="${item.id}">${item.name}</option>`);
                        });
                    },
                    error: function() {
                        console.log('Error loading categories for brand');
                    }
                });
            }

            // Xử lý sự kiện thay đổi thương hiệu
            $('#MainBrandId').change(function() {
                var brandId = $(this).val();
                if (brandId) {
                    loadProductCategories(brandId);
                } else {
                    $('#SubCategoryId').empty();
                    $('#SubCategoryId').append('<option>--Chọn phân loại--</option>');
                }
            });

            $('#image-upload').change(function() {
                var input = this;
                var previewContainer = $('#image-previews-container');
                previewContainer.empty(); // Clear previous previews

                if (input.files && input.files.length > 0) {
                    // Show the preview section
                    $('#new-images-preview').show();

                    for (var i = 0; i < input.files.length; i++) {
                        (function(i) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var imageContainer = $('<div class="position-relative m-2 image-container"></div>');
                                var imageElement = $('<img src="' + e.target.result + '" class="img-thumbnail" style="width: 150px; height: 120px; object-fit: cover;">');

                                // Add radio button for default image
                                var defaultRadio = $('<div class="form-check mt-1"><input type="radio" name="DefaultImageIndex" value="' + i +
                                                '" class="form-check-input default-image-radio" ' + (i === 0 ? 'checked' : '') + '><label class="form-check-label">Đặt làm ảnh mặc định</label></div>');

                                // Add color selection if colors exist
                                var colorSelect = $('<div class="mt-1"><select name="ImageColors[' + i + ']" class="form-select form-select-sm">' +
                                                '<option value="">Không liên kết màu</option></select></div>');

                                // Add color options from ViewBag.Colors
                                @foreach (var color in ViewBag.Colors)
                                {
                                    <text>
                                        colorSelect.find('select').append('<option value="@color.Value">@color.Text</option>');
                                    </text>
                                }

                                imageContainer.append(imageElement);
                                imageContainer.append(defaultRadio);
                                imageContainer.append(colorSelect);
                                previewContainer.append(imageContainer);
                            };
                            reader.readAsDataURL(input.files[i]);
                        })(i);
                    }
                } else {
                    // Hide the preview section if no files
                    $('#new-images-preview').hide();
                }
            });

            // Initialize - hide preview section if no images
            $('#new-images-preview').hide();
        });
    </script>
}